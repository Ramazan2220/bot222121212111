#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
üèÜ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –ò–ó–û–õ–Ø–¶–ò–ò –ù–ê PostgreSQL
100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ 500 –∞–∫–∫–∞—É–Ω—Ç–æ–≤ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
"""

import logging
import sys
import time
import threading
import random
from datetime import datetime, timedelta
from concurrent.futures import ThreadPoolExecutor, as_completed
from typing import List, Dict, Any, Set
from collections import defaultdict

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - [%(threadName)s] - %(message)s'
)
logger = logging.getLogger(__name__)

try:
    from database.db_manager import get_session, init_db
    from database.models import InstagramAccount, PublishTask, WarmupTask, TelegramUser, TaskType, TaskStatus, WarmupStatus
    from database.safe_user_wrapper import get_user_instagram_accounts, get_user_instagram_account
    from sqlalchemy import text
except ImportError as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    sys.exit(1)

class UltimateIsolationTest:
    """–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    def __init__(self):
        self.isolation_stats = {
            'users_created': 0,
            'accounts_created': 0,
            'tasks_created': 0,
            'isolation_violations': 0,
            'data_mixing_errors': 0,
            'successful_operations': 0,
            'failed_operations': 0,
            'user_data_map': {},  # user_id -> {accounts: [], tasks: []}
            'cross_contamination': [],
            'start_time': None
        }
        
        # –î–∏–∞–ø–∞–∑–æ–Ω—ã ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.USER_BASE_ID = 7000000
        self.NUM_USERS = 100
        self.ACCOUNTS_PER_USER = 500
        
    def create_single_user_with_accounts(self, user_index: int) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏"""
        
        user_id = self.USER_BASE_ID + user_index
        user_result = {
            'user_id': user_id,
            'accounts_created': 0,
            'tasks_created': 0,
            'account_ids': [],
            'task_ids': [],
            'errors': [],
            'time_taken': 0
        }
        
        start_time = time.time()
        
        try:
            with get_session() as session:
                # 1. –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                telegram_user = TelegramUser(
                    telegram_id=user_id,
                    username=f"ultimate_user_{user_index}",
                    first_name=f"Ultimate {user_index}",
                    last_name="Isolation",
                    is_active=True
                )
                session.merge(telegram_user)
                
                # 2. –°–æ–∑–¥–∞–µ–º 500 –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                for acc_index in range(self.ACCOUNTS_PER_USER):
                    account = InstagramAccount(
                        username=f"iso_{user_index}_{acc_index}_{random.randint(10000, 99999)}",
                        password=f"pass_{user_id}_{acc_index}",
                        email=f"iso_{user_index}_{acc_index}@isolation.test",
                        user_id=user_id,
                        is_active=True,
                        full_name=f"Isolation Account {user_index}-{acc_index}",
                        biography=f"Isolation test account for user {user_index}"
                    )
                    session.add(account)
                    user_result['accounts_created'] += 1
                    
                    # –ö–æ–º–º–∏—Ç–∏–º –±–∞—Ç—á–∞–º–∏ –ø–æ 50 –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                    if acc_index % 50 == 0:
                        session.flush()
                        
                session.flush()  # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ ID –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                
                # 3. –ü–æ–ª—É—á–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
                user_accounts = session.query(InstagramAccount).filter_by(user_id=user_id).all()
                user_result['account_ids'] = [acc.id for acc in user_accounts]
                
                # 4. –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
                for account in user_accounts:
                    # PublishTask
                    publish_task = PublishTask(
                        account_id=account.id,
                        user_id=user_id,
                        task_type=TaskType.VIDEO,
                        caption=f"Isolation video from user {user_index} account {account.username}",
                        scheduled_time=datetime.now() + timedelta(hours=random.randint(1, 48)),
                        status=TaskStatus.PENDING
                    )
                    session.add(publish_task)
                    
                    # WarmupTask
                    warmup_task = WarmupTask(
                        account_id=account.id,
                        status=WarmupStatus.PENDING,
                        settings={
                            'task_type': 'like',
                            'target_count': random.randint(10, 100),
                            'user_id': user_id,
                            'user_index': user_index,
                            'isolation_test': True
                        }
                    )
                    session.add(warmup_task)
                    user_result['tasks_created'] += 2
                    
                    # –ö–æ–º–º–∏—Ç–∏–º –±–∞—Ç—á–∞–º–∏
                    if len(user_result['task_ids']) % 100 == 0:
                        session.flush()
                        
                # –§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç
                session.commit()
                
                # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
                publish_tasks = session.query(PublishTask).filter_by(user_id=user_id).all()
                warmup_tasks = session.query(WarmupTask).filter(
                    WarmupTask.account_id.in_(user_result['account_ids'])
                ).all()
                
                user_result['task_ids'] = [t.id for t in publish_tasks] + [t.id for t in warmup_tasks]
                
                self.isolation_stats['users_created'] += 1
                self.isolation_stats['accounts_created'] += user_result['accounts_created']
                self.isolation_stats['tasks_created'] += user_result['tasks_created']
                self.isolation_stats['successful_operations'] += 1
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–ª—è—Ü–∏–∏
                self.isolation_stats['user_data_map'][user_id] = {
                    'accounts': user_result['account_ids'],
                    'tasks': user_result['task_ids'],
                    'user_index': user_index
                }
                
        except Exception as e:
            user_result['errors'].append(str(e))
            self.isolation_stats['failed_operations'] += 1
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_index}: {e}")
            
        user_result['time_taken'] = time.time() - start_time
        return user_result
        
    def thread_worker_create_users(self, thread_id: int, users_per_thread: int) -> List[Dict[str, Any]]:
        """–í–æ—Ä–∫–µ—Ä –ø–æ—Ç–æ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        
        thread_results = []
        
        for i in range(users_per_thread):
            user_index = thread_id * users_per_thread + i
            
            if user_index >= self.NUM_USERS:
                break
                
            user_result = self.create_single_user_with_accounts(user_index)
            thread_results.append(user_result)
            
            # –ü—Ä–æ–≥—Ä–µ—Å—Å
            if (user_index + 1) % 10 == 0:
                logger.info(f"‚úÖ –ü–æ—Ç–æ–∫ {thread_id}: —Å–æ–∑–¥–∞–Ω–æ {user_index + 1} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
                
        return thread_results
        
    def check_isolation_violations(self) -> Dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π –∏–∑–æ–ª—è—Ü–∏–∏"""
        
        logger.info("üîç –ü–†–û–í–ï–†–ö–ê –ò–ó–û–õ–Ø–¶–ò–ò: –ò—â–µ–º —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...")
        
        violation_results = {
            'cross_user_accounts': 0,
            'cross_user_tasks': 0,
            'data_leaks': [],
            'isolation_breaches': [],
            'users_checked': 0
        }
        
        try:
            with get_session() as session:
                for user_id, user_data in self.isolation_stats['user_data_map'].items():
                    violation_results['users_checked'] += 1
                    
                    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã —á–µ—Ä–µ–∑ safe wrapper
                    user_accounts = get_user_instagram_accounts(user_id)
                    expected_account_ids = set(user_data['accounts'])
                    actual_account_ids = set(acc.id for acc in user_accounts)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã
                    if actual_account_ids != expected_account_ids:
                        violation_results['cross_user_accounts'] += 1
                        violation_results['data_leaks'].append({
                            'user_id': user_id,
                            'expected_accounts': len(expected_account_ids),
                            'actual_accounts': len(actual_account_ids),
                            'extra_accounts': actual_account_ids - expected_account_ids,
                            'missing_accounts': expected_account_ids - actual_account_ids
                        })
                        
                    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –∞–∫–∫–∞—É–Ω—Ç–∞—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π user_id
                    for account in user_accounts:
                        if account.user_id != user_id:
                            violation_results['isolation_breaches'].append({
                                'type': 'account_user_id_mismatch',
                                'requesting_user': user_id,
                                'account_id': account.id,
                                'account_user_id': account.user_id
                            })
                            
                    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞—á–∏
                    publish_tasks = session.query(PublishTask).filter_by(user_id=user_id).all()
                    warmup_tasks = session.query(WarmupTask).filter(
                        WarmupTask.account_id.in_(user_data['accounts'])
                    ).all()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º publish tasks
                    for task in publish_tasks:
                        if task.user_id != user_id:
                            violation_results['cross_user_tasks'] += 1
                            violation_results['isolation_breaches'].append({
                                'type': 'publish_task_user_mismatch',
                                'requesting_user': user_id,
                                'task_id': task.id,
                                'task_user_id': task.user_id
                            })
                            
                        if task.account_id not in user_data['accounts']:
                            violation_results['cross_user_tasks'] += 1
                            violation_results['isolation_breaches'].append({
                                'type': 'publish_task_account_mismatch',
                                'requesting_user': user_id,
                                'task_id': task.id,
                                'task_account_id': task.account_id
                            })
                            
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º warmup tasks
                    for task in warmup_tasks:
                        if task.account_id not in user_data['accounts']:
                            violation_results['cross_user_tasks'] += 1
                            violation_results['isolation_breaches'].append({
                                'type': 'warmup_task_account_mismatch',
                                'requesting_user': user_id,
                                'task_id': task.id,
                                'task_account_id': task.account_id
                            })
                            
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º settings
                        if task.settings and task.settings.get('user_id') != user_id:
                            violation_results['cross_user_tasks'] += 1
                            violation_results['isolation_breaches'].append({
                                'type': 'warmup_task_settings_mismatch',
                                'requesting_user': user_id,
                                'task_id': task.id,
                                'settings_user_id': task.settings.get('user_id')
                            })
                            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–ª—è—Ü–∏–∏: {e}")
            
        return violation_results
        
    def cleanup_test_data(self):
        """–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        logger.info("üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
        
        try:
            with get_session() as session:
                # –£–¥–∞–ª—è–µ–º –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É user_id
                min_user_id = self.USER_BASE_ID
                max_user_id = self.USER_BASE_ID + self.NUM_USERS
                
                # –ó–∞–¥–∞—á–∏
                deleted_publish = session.execute(text(
                    f"DELETE FROM publish_tasks WHERE user_id >= {min_user_id} AND user_id < {max_user_id}"
                )).rowcount
                
                # Warmup –∑–∞–¥–∞—á–∏ (–ø–æ account_id)
                account_ids = []
                for user_data in self.isolation_stats['user_data_map'].values():
                    account_ids.extend(user_data['accounts'])
                    
                if account_ids:
                    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–∞—Ç—á–∏ –ø–æ 1000
                    deleted_warmup = 0
                    for i in range(0, len(account_ids), 1000):
                        batch = account_ids[i:i+1000]
                        batch_str = ','.join(map(str, batch))
                        deleted_warmup += session.execute(text(
                            f"DELETE FROM warmup_tasks WHERE account_id IN ({batch_str})"
                        )).rowcount
                else:
                    deleted_warmup = 0
                
                # –ê–∫–∫–∞—É–Ω—Ç—ã
                deleted_accounts = session.execute(text(
                    f"DELETE FROM instagram_accounts WHERE user_id >= {min_user_id} AND user_id < {max_user_id}"
                )).rowcount
                
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                deleted_users = session.execute(text(
                    f"DELETE FROM telegram_users WHERE telegram_id >= {min_user_id} AND telegram_id < {max_user_id}"
                )).rowcount
                
                session.commit()
                
                logger.info(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: {deleted_users} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, {deleted_accounts} –∞–∫–∫–∞—É–Ω—Ç–æ–≤")
                logger.info(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: {deleted_publish} publish –∑–∞–¥–∞—á, {deleted_warmup} warmup –∑–∞–¥–∞—á")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: {e}")
            
    def print_final_results(self, violation_results: Dict, total_duration: float):
        """–í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        
        logger.info("=" * 100)
        logger.info("üèÜ –ò–¢–û–ì–ò –§–ò–ù–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ê –ò–ó–û–õ–Ø–¶–ò–ò")
        logger.info("=" * 100)
        
        logger.info(f"‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {total_duration:.2f} —Å–µ–∫—É–Ω–¥")
        logger.info(f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ: {self.isolation_stats['users_created']}")
        logger.info(f"üì± –ê–∫–∫–∞—É–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: {self.isolation_stats['accounts_created']}")
        logger.info(f"üìã –ó–∞–¥–∞—á —Å–æ–∑–¥–∞–Ω–æ: {self.isolation_stats['tasks_created']}")
        
        logger.info(f"\n‚úÖ –£–°–ü–ï–®–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò:")
        logger.info(f"   üéØ –£—Å–ø–µ—à–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∏—è: {self.isolation_stats['successful_operations']}")
        logger.info(f"   ‚ùå –ù–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∏—è: {self.isolation_stats['failed_operations']}")
        
        logger.info(f"\nüîç –ü–†–û–í–ï–†–ö–ê –ò–ó–û–õ–Ø–¶–ò–ò:")
        logger.info(f"   üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: {violation_results['users_checked']}")
        logger.info(f"   üö´ –ù–∞—Ä—É—à–µ–Ω–∏–π –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º: {violation_results['cross_user_accounts']}")
        logger.info(f"   üö´ –ù–∞—Ä—É—à–µ–Ω–∏–π –ø–æ –∑–∞–¥–∞—á–∞–º: {violation_results['cross_user_tasks']}")
        logger.info(f"   üìä –£—Ç–µ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö: {len(violation_results['data_leaks'])}")
        logger.info(f"   üí• –ù–∞—Ä—É—à–µ–Ω–∏–π –∏–∑–æ–ª—è—Ü–∏–∏: {len(violation_results['isolation_breaches'])}")
        
        # –î–µ—Ç–∞–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π
        if violation_results['data_leaks']:
            logger.info(f"\nüî• –î–ï–¢–ê–õ–ò –£–¢–ï–ß–ï–ö –î–ê–ù–ù–´–•:")
            for leak in violation_results['data_leaks'][:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
                logger.info(f"   User {leak['user_id']}: –æ–∂–∏–¥–∞–ª {leak['expected_accounts']} –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –ø–æ–ª—É—á–∏–ª {leak['actual_accounts']}")
                
        if violation_results['isolation_breaches']:
            logger.info(f"\nüí• –î–ï–¢–ê–õ–ò –ù–ê–†–£–®–ï–ù–ò–ô –ò–ó–û–õ–Ø–¶–ò–ò:")
            breach_types = defaultdict(int)
            for breach in violation_results['isolation_breaches']:
                breach_types[breach['type']] += 1
            
            for breach_type, count in breach_types.items():
                logger.info(f"   {breach_type}: {count} —Å–ª—É—á–∞–µ–≤")
                
        # –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
        total_violations = (
            violation_results['cross_user_accounts'] + 
            violation_results['cross_user_tasks'] + 
            len(violation_results['data_leaks']) + 
            len(violation_results['isolation_breaches'])
        )
        
        if total_violations == 0:
            logger.info(f"\nüèÜ –ò–ó–û–õ–Ø–¶–ò–Ø –ò–î–ï–ê–õ–¨–ù–ê!")
            logger.info(f"üéâ 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ 500 –∞–∫–∫–∞—É–Ω—Ç–æ–≤ - –ë–ï–ó –°–ú–ï–®–ò–í–ê–ù–ò–Ø!")
            logger.info(f"üöÄ PostgreSQL —Å–ø—Ä–∞–≤–∏–ª—Å—è —Å —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π!")
            return True
        else:
            logger.info(f"\n‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´ –ò–ó–û–õ–Ø–¶–ò–ò!")
            logger.info(f"üìä –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: {total_violations}")
            logger.info(f"üíî –ò–∑–æ–ª—è—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏")
            return False
            
    def run_ultimate_isolation_test(self):
        """–ó–∞–ø—É—Å–∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏–∑–æ–ª—è—Ü–∏–∏"""
        
        logger.info("üèÜ" * 100)
        logger.info("üèÜ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –ò–ó–û–õ–Ø–¶–ò–ò: 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π √ó 500 –∞–∫–∫–∞—É–Ω—Ç–æ–≤")
        logger.info("üèÜ" * 100)
        
        self.isolation_stats['start_time'] = time.time()
        
        try:
            # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PostgreSQL
            logger.info("üêò –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PostgreSQL...")
            init_db()
            
            with get_session() as session:
                result = session.execute(text("SELECT version()"))
                version = result.fetchone()[0]
                logger.info(f"üêò PostgreSQL: {version[:50]}...")
                
            # 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–∞–Ω–Ω—ã—Ö
            logger.info(f"üë• –°–æ–∑–¥–∞–Ω–∏–µ {self.NUM_USERS} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å {self.ACCOUNTS_PER_USER} –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –∫–∞–∂–¥—ã–π...")
            logger.info(f"üìä –û–∂–∏–¥–∞–µ—Ç—Å—è: {self.NUM_USERS * self.ACCOUNTS_PER_USER} –∞–∫–∫–∞—É–Ω—Ç–æ–≤, {self.NUM_USERS * self.ACCOUNTS_PER_USER * 2} –∑–∞–¥–∞—á")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º 10 –ø–æ—Ç–æ–∫–æ–≤ –ø–æ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            num_threads = 10
            users_per_thread = self.NUM_USERS // num_threads
            
            all_user_results = []
            
            with ThreadPoolExecutor(max_workers=num_threads) as executor:
                futures = []
                
                for thread_id in range(num_threads):
                    future = executor.submit(self.thread_worker_create_users, thread_id, users_per_thread)
                    futures.append(future)
                    
                for future in as_completed(futures):
                    try:
                        thread_results = future.result(timeout=600)  # 10 –º–∏–Ω—É—Ç –Ω–∞ –ø–æ—Ç–æ–∫
                        all_user_results.extend(thread_results)
                        logger.info(f"‚úÖ –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω, –≤—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(all_user_results)}")
                    except Exception as e:
                        logger.error(f"üí• –ü–æ—Ç–æ–∫ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è: {e}")
                        
            # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏
            logger.info("üîç –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑–æ–ª—è—Ü–∏–∏...")
            violation_results = self.check_isolation_violations()
            
            # 4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            total_duration = time.time() - self.isolation_stats['start_time']
            success = self.print_final_results(violation_results, total_duration)
            
            # 5. –û—á–∏—Å—Ç–∫–∞
            self.cleanup_test_data()
            
            return success
            
        except Exception as e:
            logger.error(f"üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –¢–ï–°–¢–ê: {e}")
            return False

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    
    test = UltimateIsolationTest()
    success = test.run_ultimate_isolation_test()
    
    if success:
        print("\nüèÜ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –ò–ó–û–õ–Ø–¶–ò–ò –ü–†–û–ô–î–ï–ù!")
        print("üéâ 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π √ó 500 –∞–∫–∫–∞—É–Ω—Ç–æ–≤ - –ò–ó–û–õ–Ø–¶–ò–Ø –ò–î–ï–ê–õ–¨–ù–ê!")
        print("üöÄ PostgreSQL –≤—ã–¥–µ—Ä–∂–∞–ª —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É!")
        exit(0)
    else:
        print("\n‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´ –ò–ó–û–õ–Ø–¶–ò–ò!")
        print("üîß –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏")
        exit(1)

if __name__ == "__main__":
    main() 